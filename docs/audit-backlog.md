# Бэклог по результатам аудита (январь 2025)

> Задачи отсортированы по приоритету (High / Medium). Каждая задача содержит конкретные подзадачи для поэтапного внедрения.

## 1. Безопасность доступа и ролей

### 1.1 [High] Удалить «одноразовое» повышение до админа из клиента
- [ ] Перенести логику проверки `seedCode` полностью на Cloud Functions и удалить чтение `VITE_ADMIN_SEED_CODE` из фронтенда.
- [ ] Удалить компонент `MakeMeAdmin` и все связанные UI-кнопки (`src/pages/Admin.tsx`).
- [ ] Переиспользовать существующий `setRole`/`makeUserAdmin` для контролируемого повышения прав.
- [ ] Ротация уже утёкшего seed-кода и документирование нового процесса онбординга администраторов.

### 1.2 [High] Разрешить super-admin пользователю запускать служебные функции
- [ ] Обновить `ensureAdmin` в `functions/src/index.ts`, чтобы принимать роли `admin` и `super-admin`.
- [ ] Перепроверить/адаптировать `makeUserAdmin`, `setRole`, `runVerify`, `runReconcile` и другие callable, чтобы не ломать существующие проверки.
- [ ] Прописать автоматический тест (например, emulated callable), подтверждающий доступ для обоих ролей.

### 1.3 [High] Привести Storage rules и UI к единой политике ролей
- [ ] В `storage.rules` разрешить `write`/`delete` операциям, если `request.auth.token.role` ∈ {`admin`, `super-admin`}.
- [ ] Обновить проверки в `src/pages/UploadAsset.tsx` и любых других загрузчиках на ту же логику.
- [ ] Протестировать загрузку из аккаунта super-admin (Storage emulator или staging-проект).

## 2. Логи и приватность

### 2.1 [High] Очистить продакшен-логирование чувствительных данных
- [ ] Убрать/загардить недетские `console.log` в модулях Firebase (`src/lib/firebase.ts`, `src/lib/testResults.ts`, `src/hooks/useNotes.ts`, `src/pages/UploadAsset.tsx`, `src/pages/Admin.tsx`, др.).
- [ ] Ввести флаг (например, `import.meta.env.DEVLOG`) и логировать только в dev-режиме.
- [ ] Добавить линт-проверку или pre-commit hook на запрет `console.log` в `src/lib`/`src/pages` для продакшен-сборок.

## 3. Данные и UX

### 3.1 [Medium] Исправить статистику администратора в профиле
- [ ] Пересчитать `totalPeriods`/`publishedPeriods` без «+1» и с учётом интро-документа.
- [ ] Считать количество администраторов корректно (можно перенести агрегацию в Cloud Function, чтобы не перетягивать всю коллекцию на клиент).
- [ ] Покрыть компонент небольшим unit-тестом или сторибуком с мок-данными.

### 3.2 [Medium] Восстановить CSV-режим или удалить переключатель
- [ ] Добавить в `public/content/` актуальные `periods.csv`, `intro.csv` (либо изменить код, чтобы файл искался в другом месте).
- [ ] Проверить `useDataSource`/`usePeriods`/`useIntro` в обоих режимах (Firestore и CSV).
- [ ] Если CSV-режим больше не нужен — удалить фичу и все связанные скрипты/кнопки.

## 4. Производительность и сборка

### 4.1 [Medium] Разбить бандл на лениво грузимые части
- [ ] Ввести `React.lazy` + `Suspense` и/или `manualChunks` в `vite.config.js`, чтобы выделить страницы (Tests, Timeline, Admin, Timeline редактор) в отдельные чанки.
- [ ] Перепроверить импорт `src/lib/tests.ts`: устранить смешение `import()` и статических импортов или вынести функционал в отдельный модуль.
- [ ] Настроить CI-лимит `build.chunkSizeWarningLimit` и добавить метрику размера бандла в отчёты.

---

_После выполнения каждой задачи обновляйте этот файл (ставьте ✅, дописывайте ссылки на PR и заметки по регрессиям)._
