# Timeline Guide

Подробное описание текущей реализации страницы `src/pages/Timeline.tsx`.

## Обзор

- Доступна авторизованным пользователям по маршруту `/timeline`.
- Рендерится как полноэкранный `SVG`‑холст с панелями управления слева и справа.
- Основная цель — визуализировать жизненный путь пользователя, фиксировать события, личные решения и альтернативные ветки развития.

## UI-структура

- **Левая панель** (`fixed left`):
  - Кнопка возврата в профиль.
  - Поле текущего возраста — влияет на длину «прожитой» части основной линии.
  - Ползунок «Прокрутка» — вертикально перемещает вьюпорт по возрастам.
  - Вертикальный слайдер масштаба и отображение текущего zoom'а.
  - Блок статистики: количество событий и распределение по сферам.
- **Центральный холст**:
  - Вертикальная линия жизни по центру (`LINE_X_POSITION = 2000`), разделённая на сплошную (прошедшее) и пунктирную (будущее) части.
  - Шкала возраста каждые 5 лет по всей ширине холста.
  - События отображаются как окружности с подписью, цвет зависит от сферы, отметка «решение» рисуется крестиком.
  - Горизонтальные «веточки» соединяют событие с родительской линией (основной или ответвлением).
  - Отдельные вертикальные линии (edges) визуализируют ветки с собственным диапазоном возрастов.
- **Правая панель** (`fixed right`):
  - Заголовок с индикатором статуса сохранения (idle/saving/saved/error).
  - Универсальная форма создания/редактирования события.
  - Информеры о выбранной ветке или основной линии.
  - При выборе ветки показывается редактор длины ветки и кнопка удаления.
  - Блок Undo/Redo с горячими клавишами.
  - Модальное окно с инструкцией (управляется `showHelp`), по умолчанию скрыто — вызов планируется через UI-триггер.

## Модель данных

- **Событие (`NodeT`)**
  - `id`, `age`, `label`, `notes`, `isDecision`.
  - `sphere` опционален, выбран из перечисления `Sphere`.
  - `x` — горизонтальная координата (совпадает с линией, если событие на основной оси).
  - `parentX` — исходная линия, с которой было создано событие (помогает строить горизонталь).
- **Ветка (`EdgeT`)**
  - `id`, `x`, `startAge`, `endAge`, `color`, `nodeId` (событие-источник).
- **TimelineData**
  - `currentAge`, `ageMax` (фиксирован 100), `nodes`, `edges`.
- История (`history`, `historyIndex`) хранит последовательные снимки `nodes + edges` с глубиной до 50 шагов.

## Ключевые сценарии

**Пиктограммы**
- В шапке форм добавлена кнопка выбора иконки; доступен всплывающий селектор из 40 PNG (`public/icons/events`, метаданные `icons.json`). Выбор сохраняется в `iconId` и заменяет стандартный круг на холсте.
- Пиктограмма масштабируется вместе с событием; базовый круг и крестик скрываются, чтобы не мешать.
- Для событий без пиктограммы круг остаётся белым с цветной обводкой сферы, крестик «моё решение» отображается поверх.
- **Редактирование события**
  - Клик по событию открывает форму с текущими данными и фиксирует исходные значения для проверки изменений.
  - Добавлены кнопка отмены и возможность удаления события (удаляет и связанные ветки).
- **Ветки**
  - Кнопка «Продолжить ветку» в форме события создаёт вертикальный edge заданной длины.
  - В правой панели доступно изменение длины ветки и удаление (события на ней возвращаются к родительской линии).
  - При перетаскивании события обновляются координаты его веток и всех прикреплённых к ним событий.
- **Перемещение и масштаб**
  - Колесо мыши масштабирует сцену с привязкой к главной линии (ограничение `0.2 ≤ k ≤ 3`).
  - Перетаскивание холста мышью; вьюпорт также синхронизируется с ползунком возраста.
  - События перетаскиваются pointer-событиями; по завершении drag состояние сохраняется в историю.
- **Undo/Redo и горячие клавиши**
  - Cmd/Ctrl+Z, Cmd/Ctrl+Shift+Z работают вне текстовых полей.
  - Delete удаляет выбранное событие, Escape снимает выделение.

## Сохранение и загрузка

- Автосохранение (`setTimeout` на 10 секунд) срабатывает при наличии событий или веток.
- Перед отправкой в Firestore данные проходят через `removeUndefined`.
- Документ сохраняется в коллекции `timelines/{userId}` с `updatedAt`.
- При загрузке:
  - Восстанавливаются события и ветки, нормализуются `x`/`parentX`.
  - Вьюпорт центрируется по текущему возрасту (или по рождению, если данных нет).

## Стили и визуал

- Сферы жизни используют пастельную палитру, совпадающую с `SPHERE_META`.
- Подписи и большинство текстов в панели — шрифт `Georgia, serif`.
- Холст масштабирован на ширину `4000px`, что оставляет пространство для боковых веток.
- Индикатор сохранения и панели оформлены градиентными фонами и полупрозрачными блоками.

## Известные проблемы и решения

### Проблема: события не двигаются вместе с родительской веткой

**Симптомы**: При перетаскивании события, от которого идёт ветка, дочерние события на этой ветке «зависают в воздухе» и не следуют за родителем.

**Система координат**:
- `node.x` — текущая X-координата события
- `node.parentX` — X-координата родительской линии (обновляется при движении родителя)
- `edge.x` — X-координата вертикальной линии ветки
- Y-координата абсолютна и определяется возрастом события

**Причина бага**: В функции `handleNodeDragMove` (Timeline.tsx:673) использовалась координата начала перетаскивания (`dragStartNodeX`) вместо текущей координаты события:

```typescript
// НЕПРАВИЛЬНО:
const oldX = dragStartNodeX; // Координата в начале перетаскивания

// ПРАВИЛЬНО:
const oldX = node.x ?? LINE_X_POSITION; // Текущая координата события
```

При использовании стартовой координаты:
1. Первое движение мыши: находит детей с `parentX === 2100`, обновляет их на `parentX === 2110`
2. Второе движение мыши: ищет детей с `parentX === 2100`, не находит никого (они уже 2110)
3. Дети перестают обновляться

**Решение**: Всегда использовать **текущую** координату события (`node.x`) в рекурсивной функции обновления. Это гарантирует, что на каждом шаге перетаскивания система найдёт всех актуальных потомков.

**Рекурсивное обновление** (Timeline.tsx:676-726):
- Находит все события с `parentX === fromX`
- Обновляет их `parentX` на `toX`
- Для событий **на линии** (`node.x === fromX`): перемещает на `toX`
- Для событий **со смещением** (`node.x !== fromX`): сохраняет смещение через `deltaX`
- Рекурсивно обрабатывает ветки от этих событий

## Риски и планы на развитие

- UI зависит от полноэкранного рендера; при встраивании в другую оболочку потребуется адаптация `transform`.
- Нет явного триггера для открытия модального окна помощи — стоит добавить кнопку/клавишу.
- Потребуется отдельная документация по миграции старых данных (без `edges`/`parentX`) при развёртывании.
- Возможное расширение: экспорт таймлайна, фильтрация по сферам, история ветвлений во времени.
