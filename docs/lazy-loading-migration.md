# План миграции на ленивую загрузку (lazy loading)

> Цель: снизить размер первоначального бандла (~3.9 МБ) и ускорить первый рендер, не ломая текущую архитектуру Vite + React Router.  
> Под «этап» понимается крупный блок работ. Каждый этап разбит на шаги, а шаги — на конкретные действия. Выполняйте этапы последовательно.

---

## Этап 1. Подготовка и измерения

### 1.1 Зафиксировать текущие метрики
- [ ] Выполнить `npm run build` и сохранить статистику (`dist/assets/index-*.js` размер, gzip).
- [ ] Снять отчёт Lighthouse для основных сценариев (главная, `/tests`, `/timeline`, `/admin`) в мобильном профиле.
- [ ] Задокументировать результаты (например, в `docs/perf-metrics.md`) — понадобится для сравнения после внедрения.

### 1.2 Инвентаризация маршрутов и зависимостей
- [ ] Пройтись по `src/App.jsx` и выписать все `Route` (главные, RequireAuth, RequireAdmin, superadmin-only).
- [ ] Для каждой страницы указать: размер файла, ключевые зависимости (Timeline хуки, тестовый редактор, Firebase hooks).
- [ ] Отметить компоненты, которые уже используются синхронно внутри других страниц (например, `NotesEditor`, `LoginModal`) — их нельзя резать бездумно.

### 1.3 Определить критический путь загрузки
- [ ] Решить, какой минимум должен приезжать синхронно (главная, авторизация, базовые хуки, общие UI-компоненты).
- [ ] Согласовать список «тяжёлых» модулей для ленивой загрузки: `Admin`, `AdminUsers`, `AdminContent`, `AdminContentEdit`, `AdminTopics`, `Timeline`, `TestsPage`, `DynamicTest`, `Notes`, возможно — модальные редакторы (`TestEditorModal` и related hooks).
- [ ] Зафиксировать список в документе (в конце этого файла или отдельным приложением).

---

## Этап 2. Подготовка инфраструктуры

### 2.1 Общые точки доступа
- [ ] Создать файл `src/pages/lazy.ts` (или аналог) с экспортами `const Admin = lazy(() => import('./pages/Admin'));` и т.п. Это упростит поддержку и единообразие.
- [ ] Добавить централизованный fallback-компонент (например, `src/components/ui/PageLoader.tsx`) для отображения skeleton при загрузке чанка.

### 2.2 Подготовка кода роутера
- [ ] В `App.jsx` обернуть секцию `<Routes>` в `<Suspense fallback={<PageLoader />}>`.
- [ ] Для критичных вложенных маршрутов (например, RequireAdmin) продумать кастомные fallback (можно оставить общий).
- [ ] Убедиться, что контекст `AuthInitializer` и магазины Zustand создаются до загрузки ленивых компонентов (иначе хуки не получат состояние).

### 2.3 Вынесение общих зависимостей
- [ ] Проверить, что тяжёлые модули не тянут за собой ненужный код. При необходимости вынести shared-утилиты в `src/lib/shared` (например, функции форматирования, хелперы Firebase).
- [ ] Убедиться, что `useAuthStore`, `useTimelineState`, `useNotes` и т.д. не импортируют страниц напрямую (иначе ленивый чанк будет затягиваться в базовый бандл).

---

## Этап 3. Ленивая загрузка страниц

### 3.1 Admin-зона
- [ ] Заменить синхронные импорты `Admin`, `AdminUsers`, `AdminContent`, `AdminContentEdit`, `AdminTopics`, `UploadAsset`, `MigrateTopics` на `React.lazy`.
- [ ] Проверить, что `RequireAdmin`/`RequireAuth` работают корректно с ленивыми компонентами (при необходимости оборачивать внутри `Suspense`).
- [ ] Протестировать сценарии: вход под обычным студентом, вход под админом, вход под супер-админом (учтите условные маршруты).

### 3.2 Тесты и прохождение тестов
- [ ] Лениво грузить `TestsPage` (две вариации `rubricFilter`), `DynamicTest`, редактирование тестов (если используется `TestEditorModal`/`TestEditorForm` как отдельная страница).
- [ ] Особое внимание `DynamicTest`: убедиться, что хуки `useTestProgress`, `useAnswerValidation`, `useQuestionNavigation` остаются доступными (они импортированы синхронно — это нормально, если сами хуки лёгкие).
- [ ] Проверить, что `TestHistory` (который тянет Firestore) не вызывает лишних запросов до загрузки страницы.

### 3.3 Таймлайн и заметки
- [ ] Лениво грузить `Timeline` и связанные тяжёлые хуки (`useTimelineState` и пр. остаются синхронными, но сами компоненты — нет).
- [ ] Для `Notes` и модальных компонентов (`NotesEditor`, `NoteModal`, `SaveNoteAsEventButton`) решить, нужны ли отдельные чанки. Если модалка часто используется, можно оставить синхронной, иначе вынести.
- [ ] Прогнать e2e-сценарий: открыть Timeline, добавить событие, вернуться к заметкам.

### 3.4 Дополнительные страницы
- [ ] Проверить, не стоит ли лениво грузить `Profile`, `Login`, `TestsPage` подстрницы (`/tests/age-periods`).
- [ ] Для небольших страниц (например, `AppInner`-плейсхолдеры периодов) оставить синхронную загрузку, чтобы не плодить лишние чанки.

---

## Этап 4. Настройка Rollup/Vite

### 4.1 manualChunks
- [ ] В `vite.config.js` добавить `build.rollupOptions.output.manualChunks`, чтобы стабилизировать структуру чанков: например, `{ 'timeline': ['src/pages/Timeline.tsx'], 'tests-module': ['src/pages/TestsPage.tsx', 'src/pages/DynamicTest.tsx'], 'admin-module': [...] }`.
- [ ] Следить, чтобы общие библиотеки (React, Firebase, Zustand) оставались в основном чанке, а не дублировались.

### 4.2 Анализ результата
- [ ] Запустить `npm run build` и проверить размеры новых файлов; целевой ориентир — основной JS < 500 кБ, ленивые чанки по 200–600 кБ.
- [ ] Обновить Lighthouse-отчёт и сравнить с базовым (см. Этап 1).
- [ ] Задокументировать структуру чанков (список файлов → какую функциональность содержат).

---

## Этап 5. Тестирование и регрессии

### 5.1 Юнит/интеграционные тесты
- [ ] Прогнать `npm run test` — убедиться, что Vitest справляется с `React.lazy` (при необходимости добавить `await waitFor` в тесты, где компоненты рендерятся асинхронно).
- [ ] Дополнить тесты `@testing-library/react` там, где появился `Suspense`.

### 5.2 E2E/ручное тестирование
- [ ] Проверить основные сценарии: вход, просмотр периодов, запуск теста, сохранение заметок, работа таймлайна, операции администратора, загрузка ассетов.
- [ ] Особо протестировать поведение при медленном интернете (Chrome DevTools → Throttling → Slow 3G) — должны отображаться fallback-компоненты, без белых экранов.

### 5.3 Обновление документации
- [ ] Обновить README/внутренние инструкции: указать, что крупные страницы грузятся лениво, и добавить заметки для разработчиков (как правильно добавлять новые ленивые страницы).
- [ ] Зафиксировать финальные метрики в `docs/perf-metrics.md`.

---

## Приложение A. Рекомендуемые ленивые модули (стартовый список)

- `Admin`, `AdminUsers`, `AdminContent`, `AdminContentEdit`, `AdminTopics`, `UploadAsset`, `MigrateTopics`.
- `Profile`, `Notes`, `Timeline`, `TestsPage`, `DynamicTest`.
- Редактор тестов (`components/tests/editor/*`, `TestEditorModal`) — если используется как отдельная страница.

> Список можно корректировать после первой итерации: цель — минимизировать размер initial chunk при сохранении отзывчивости интерфейса.
