# Cost Guardrails

> Цель: предотвратить рост затрат на хранение и деплойные артефакты.
> **Последнее обновление:** 2026-01-17

## Где смотреть расходы

### GCP Billing
- Reports → фильтр по `Artifact Registry` и `Cloud Run`.
- Сравнивать недели с пиками деплоев.

### Artifact Registry
- Размер repo (sizeBytes) и рост количества digest'ов.
- Особое внимание cache-образам и untagged версиям.

### Cloud Run
- Количество ревизий на сервис.
- Доля ревизий с `traffic=0%`.

## Политика Artifact Registry (рекомендованный минимум)

**Базовая политика:** удалять `untagged` версии старше `N` дней (например, `N=14`).
- Tagged версии не удаляются автоматически.
- Исключать критичные теги (`latest`, `prod`, `release*`) из авто-удаления.
- Перед включением политики — проверить фактических потребителей образов.

**Почему это безопасно:**
- Untagged версии обычно не используются напрямую.
- Сохраняется возможность отката по tag'ам и активным digest'ам.

## Политика Cloud Run revisions

Cloud Run не имеет встроенной retention-политики. Рекомендуемое правило:
- Всегда сохранять активные ревизии (`traffic>0`).
- Дополнительно хранить последние `KEEP_LAST_N` ревизий для отката.
- Удалять ревизии с `traffic=0%`, старше `X` дней.

Если автоматизация не настроена:
- Делать ручную чистку после активных релизов.
- Фиксировать изменения в `CLEANUP_LOG.md`.

## Чек-лист после дня интенсивных деплоев
- Проверить количество ревизий Cloud Run.
- Проверить рост digest'ов в Artifact Registry.
- Убедиться, что `KEEP_LAST_N` соблюдён.
- Обновить `CLEANUP_SUMMARY.md`.

## Чек-лист перед публикацией/PR
- Убедиться, что `.env.*` не tracked (кроме `.env.example`).
- Проверить `.gitignore` на env/keys/artifacts.
- Запустить быстрый secret-scan по репозиторию.

**См. также:**
- `docs/SECURITY_BASELINE.md`
- `docs/POSTMORTEM_COST_AND_SECURITY.md`
